<MAPPING NAME="m_Customer_Segmentation" DESCRIPTION="Customer segmentation logic" VERSIONNUMBER="1.0">
    <SOURCE NAME="SRC_CUSTOMERS" DATABASETYPE="Oracle">
        <SOURCEFIELD NAME="CUSTOMER_ID" DATATYPE="number" PRECISION="10" SCALE="0"/>
        <SOURCEFIELD NAME="CUSTOMER_NAME" DATATYPE="varchar2" PRECISION="200"/>
        <SOURCEFIELD NAME="TOTAL_PURCHASES" DATATYPE="number" PRECISION="15" SCALE="2"/>
        <SOURCEFIELD NAME="ACCOUNT_AGE_DAYS" DATATYPE="number" PRECISION="5" SCALE="0"/>
    </SOURCE>
    
    <TRANSFORMATION NAME="EXP_CALCULATE_SEGMENT" TYPE="Expression" DESCRIPTION="Calculate customer segment">
        <TRANSFORMFIELD NAME="CUSTOMER_ID" DATATYPE="number" PRECISION="10"/>
        <TRANSFORMFIELD NAME="CUSTOMER_NAME" DATATYPE="varchar2" PRECISION="200"/>
        <TRANSFORMFIELD NAME="TOTAL_PURCHASES" DATATYPE="number" PRECISION="15"/>
        <TRANSFORMFIELD NAME="AVG_MONTHLY_SPEND" DATATYPE="number" PRECISION="10" EXPRESSION="TOTAL_PURCHASES / (ACCOUNT_AGE_DAYS / 30)"/>
        <TRANSFORMFIELD NAME="SEGMENT" DATATYPE="varchar2" PRECISION="20" EXPRESSION="IIF(AVG_MONTHLY_SPEND > 1000, 'PREMIUM', IIF(AVG_MONTHLY_SPEND > 500, 'GOLD', 'STANDARD'))"/>
    </TRANSFORMATION>
    
    <TRANSFORMATION NAME="FIL_ACTIVE_CUSTOMERS" TYPE="Filter" DESCRIPTION="Keep only active segments">
        <FILTERCONDITION>SEGMENT != 'STANDARD'</FILTERCONDITION>
    </TRANSFORMATION>
    
    <TARGET NAME="TGT_CUSTOMER_SEGMENTS" DATABASETYPE="BigQuery">
        <TARGETFIELD NAME="CUSTOMER_ID" DATATYPE="INT64" NULLABLE="false"/>
        <TARGETFIELD NAME="CUSTOMER_NAME" DATATYPE="STRING" NULLABLE="false"/>
        <TARGETFIELD NAME="AVG_MONTHLY_SPEND" DATATYPE="FLOAT64" NULLABLE="true"/>
        <TARGETFIELD NAME="SEGMENT" DATATYPE="STRING" NULLABLE="true"/>
    </TARGET>
</MAPPING>
